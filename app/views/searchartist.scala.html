<!DOCTYPE html>
<html>
<head>
    <title>Search Artist</title>

    <link rel="stylesheet" type="text/css" href="@routes.Assets.at("stylesheets/myspotify2.css")">
    <link rel="stylesheet" type="text/css" href="@routes.Assets.at("stylesheets/style.css")">
    <script src="http://cdnjs.cloudflare.com/ajax/libs/mustache.js/0.7.0/mustache.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <script type="text/javascript" src='@routes.Assets.at("javascripts/typeahead.bundle.js")'></script>

    <!-- ****************************** MUSTACHE TEMPLATE START ****************************** -->
    <script id="artistTemplate" type="text/template">
        <div class="containerTest">
            <!-- Example row of columns -->
            <div class="imageDiv">
                <div style="width: {{width}};display: inline-block;position: relative;left: 0;vertical-align:top;margin-right: 50px">
                    <img height="{{height}}" width="{{width}}" src="{{url}}">
                </div>
                <div class="trackDiv">
                    <h2>Top tracks</h2>
                    <div class="borderStyle">&nbsp;</div>
                    <div id="list2">
                        <ol>
                            {{#tracks}}
                                <li><p><em><a href="{{spotifyurl}}" target="_blank">{{track}}</a></em></p></li>
                            {{/tracks}}
                        </ol>
                    </div>
                </div>
                <div class="albumDiv">
                    <h2>Albums</h2>
                    <div class="borderStyle">&nbsp;</div>
                    <div id="list2">
                        <ol>
                            {{#albums}}
                            <li><p><em>{{album}}</em></p></li>
                            {{/albums}}
                        </ol>
                    </div>
                </div>
                <div class="artistDiv">
                    <h2>Related artists</h2>
                    <div class="borderStyle">&nbsp;</div>
                    <div id="list2">
                        <ol>
                            {{#relatedartists}}
                            <li><p><em><a onclick="javascript:populateArtistData('{{id}}', '{{artist}}')" href="#">{{artist}}</a></em></p></li>
                            {{/relatedartists}}
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </script>
    <!-- ****************************** MUSTACHE TEMPLATE END ****************************** -->
</head>
<body>
    <div id="wrapper">
        <div style="width: 100%; margin: 0 auto; padding-left: 20px; padding-top: 10px;">
           <table><tr><td><input placeholder="search artist here.." id="typeAheadArtist" class="typeahead"></input></td><td><span id="txtInfo" style="display:none;"></span></td></tr></table>
            <br>
            <div id="artistWrapper"></div>
        </div>
    </div>

    <script type="text/javascript">

    // get websocket class, firefox has a different way to get it
    var WS = window['MozWebSocket'] ? window['MozWebSocket'] : WebSocket;

    // open pewpew with websocket
    var socket = new WS('@routes.Application.wsInterface().webSocketURL(request)');

    var writeMessages = function(event){
    console.log( "test: " + $('#typeAheadArtist').val() );
    console.log( "event.data: " + event.data );

       if(event.data != $('#typeAheadArtist').val()){
         $('#txtInfo').html("Någon annan söker just nu på:<i> " + event.data + "</i>");
         $( "#txtInfo" ).fadeIn( "slow", function() { $( "#txtInfo" ).fadeOut(4000, function() {}); });
         }
    }

    socket.onmessage = writeMessages;

   var artists = new Bloodhound({
        datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
        queryTokenizer: Bloodhound.tokenizers.whitespace,
        remote: 'searchArtists?query=%QUERY'
    });

    artists.initialize();

    $('.typeahead').typeahead(
        null, {
        name: 'artists',
        displayKey: 'name',
        source: artists.ttAdapter()
    }).on('typeahead:selected', function(event, data){
        console.log(data.id);
        populateArtistData(data.id, data.name)
    });

    function populateArtistData(id, artist){
      $.getJSON( "artistInfo?artistId="+id, function(data) {
         var template = $('#artistTemplate').html();
         var html = Mustache.to_html(template, data);
         $('#artistWrapper').html(html);
         $('#typeAheadArtist').val(artist);
         socket.send(artist);
        }).done(function() {
            console.log( "second success" );
        }).fail(function() {
            console.log( "error" );
        }).always(function() {
            console.log( "complete" );
        });
    }

</script>
</body>
</html>